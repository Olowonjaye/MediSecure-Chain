const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Audit-Dm077oLr.js","assets/index-nTQIyIYe.js","assets/index-C41OvRKd.css","assets/react-toastify.esm-UE-0H8Ct.js"])))=>i.map(i=>d[i]);
import{r as ye,a as r,j as e,u as we,B as Y,k as ge,t as je,h as ee,b as Ne,C as ve,c as Se,_ as ke}from"./index-nTQIyIYe.js";import{h as k}from"./hospitalApi-BvT66DJ5.js";import Ce from"./AccessControl--pi3Azol.js";import{Q as Z}from"./react-toastify.esm-UE-0H8Ct.js";let te=!1;const se=function(a){return new Uint8Array(ye(a))};let ae=se;function T(a){return ae(a)}T._=se;T.lock=function(){te=!0};T.register=function(a){if(te)throw new Error("randomBytes is locked");ae=a};Object.freeze(T);const Re=r.forwardRef(({patient:a},m)=>a?e.jsxs("div",{ref:m,className:"bg-white p-6 rounded-lg shadow-sm text-slate-800 print:p-0 print:shadow-none",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Patient Summary"}),e.jsxs("div",{className:"text-sm mb-4",children:["Name: ",a.name]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm mb-4",children:[e.jsxs("div",{children:["MRN: ",a.id||a.patientId||a.mrn||a._id]}),e.jsxs("div",{children:["DOB: ",a.dob||a.dateOfBirth||"â€”"]}),e.jsxs("div",{children:["Gender: ",a.gender||"â€”"]}),e.jsxs("div",{children:["Nationality: ",a.nationality||a.nationality||"â€”"]}),e.jsxs("div",{children:["State: ",a.state||"â€”"]}),e.jsxs("div",{children:["Local Govt: ",a.localGovernment||"â€”"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Allergies"}),e.jsx("div",{className:"text-sm",children:a.allergies||"None recorded"})]}),e.jsxs("div",{className:"text-xs text-slate-500",children:["Generated: ",new Date().toLocaleString()]})]}):null),W="https://console.storacha.network",X="z6MktH33UpQ2nubm7mGS2oZi3zhQRt5DHjLqqtjBTkhVUkpk";async function Ae(a){return await new Promise((m,o)=>{const d=new FileReader;d.onerror=()=>o(new Error("Failed to read file")),d.onload=()=>m(d.result),d.readAsArrayBuffer(a)})}async function Pe(a){const m=await window.crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),o=window.crypto.getRandomValues(new Uint8Array(12)),d=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},m,a),w=new Uint8Array(d),g=new Uint8Array(o.length+w.length);g.set(o,0),g.set(w,o.length);const j=new Uint8Array(await window.crypto.subtle.exportKey("raw",m));return{combined:g,keyRaw:j}}async function De(a){const m=await window.crypto.subtle.digest("SHA-256",a);return ee(new Uint8Array(m))}function Ie(){const[a,m]=r.useState(null),[o,d]=r.useState(""),[w,g]=r.useState(""),[j,f]=r.useState([]),[b,N]=r.useState([]),[u,v]=r.useState(!1),[x,R]=r.useState(1),[E,P]=r.useState(!1),[D,I]=r.useState(""),[A,L]=r.useState(""),[M,O]=r.useState(""),[_,$]=r.useState(!1),{addToast:l}=we(),[re,H]=r.useState(!1),[G,q]=r.useState(!1),[i,z]=r.useState(null),ne=r.useRef(),[oe,K]=r.useState(!1),le=s=>m(s.target.files[0]||null),Q=async s=>{try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(String(s)),l("Copied to clipboard","success"),!0}catch{}try{const t=document.createElement("textarea");return t.value=String(s),document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),l("Copied to clipboard","success"),!0}catch(t){return console.warn("copy fallback failed",t),l("Copy failed","error"),!1}},ie=()=>{const s=document.createElement("div");s.innerHTML=`<div style="font-family: sans-serif; padding:20px; max-width:800px;">${document.querySelector(".patient-summary-print")?document.querySelector(".patient-summary-print").innerHTML:"<h2>Patient Summary</h2>"}</div>`;const t=window.open("","_blank");if(!t){l("Unable to open print preview (popup blocked)","error");return}t.document.write("<html><head><title>Patient Summary</title></head><body>"),t.document.write(s.innerHTML),t.document.write("</body></html>"),t.document.close(),setTimeout(()=>{try{t.focus(),t.print()}catch(n){console.warn("Print preview error",n)}},300)};r.useEffect(()=>{let s=!0;return(async()=>{try{const t=await k.listPatients();s&&Array.isArray(t)&&f(t)}catch(t){console.warn("Could not fetch patients",t)}})(),()=>{s=!1}},[]),r.useEffect(()=>{if(!o||o.length<2){N([]),P(!1),R(1);return}let s=!0;const t=setTimeout(async()=>{try{v(!0);const n=await k.searchPatients(o,1,10);if(!s)return;const p=Array.isArray(n)?n:n.items||n.results||[];N(p);const c=n.total||n.totalCount||n.count||null;P(!!(c&&p.length<c)),R(1)}catch(n){console.warn("Search error",n),s&&N([])}finally{s&&v(!1)}},300);return()=>{s=!1,clearTimeout(t)}},[o]);const ce=async()=>{try{const s=x+1;v(!0);const t=await k.searchPatients(o,s,10),n=Array.isArray(t)?t:t.items||t.results||[];N(c=>[...c,...n]);const p=t.total||t.totalCount||t.count||null;P(!!(p&&b.length+n.length<p)),R(s)}catch(s){console.warn("Load more search failed",s)}finally{v(!1)}},de=async s=>{if(s.preventDefault(),!a||!(w||o)){l("Please select an existing patient or enter a new patient name","error");return}if(!window.crypto||!window.crypto.subtle){l("Web Crypto API not available in this browser","error");return}try{$(!0),l("Encrypting file and uploading to IPFS...","info");const t=await Ae(a),{combined:n,keyRaw:p}=await Pe(t);let c=w;if(!c){const h=await k.createPatient({name:o});if(c=h.id||h.patientId||h.mrn||h._id||null,!c)throw new Error("Failed to create patient or receive patient id from backend");l(`Created patient ${o} (${c})`,"success");try{f(await k.listPatients())}catch{}}let F=null;try{const h=new Blob([n],{type:"application/octet-stream"}),y=new FormData;y.append("file",h,a.name+".enc"),y.append("recordType",D),y.append("recordDate",A),y.append("description",M);const C=await k.postRecordFile(c,y);l("File uploaded to hospital backend","success"),F=C.proof||C.cid||C.uploadId||null,z(B=>({...B,backendProof:F,patientId:c}))}catch(h){console.warn("Hospital upload failed, will attempt Storacha upload",h)}if(X)try{const h=`${W.replace(/\/$/,"")}/api/upload`,y=new FormData;y.append("file",new Blob([n],{type:"application/octet-stream"}),a.name+".enc");const C=await fetch(h,{method:"POST",headers:{Authorization:`Bearer ${X}`},body:y});if(!C.ok)throw new Error(`Storacha upload failed: ${C.statusText}`);const B=await C.json(),S=B.cid||B.cidStr||B.id||null,me=await De(n.buffer);if(S&&window.ethereum){const V=new Y(window.ethereum);await V.send("eth_requestAccounts",[]);const ue=await(await V.getSigner()).getAddress(),J=ge(je(ue+S)),he=ee(T(32)),pe=JSON.stringify({patientId:c,patientName:o,recordType:D,recordDate:A,description:M,fileName:a.name,backendProof:F,ownerEncryptedKey:he,storachaDid:"z6MktH33UpQ2nubm7mGS2oZi3zhQRt5DHjLqqtjBTkhVUkpk"});l("Registering record on-chain (transaction will be requested)...","info");const U=await Ne(J,S,me,pe),xe=U&&(U.transactionHash||U.transaction&&U.transaction.hash)||null;l("âœ… Record uploaded and proof registered","success"),z(be=>({...be||{},backendProof:F,cid:S,onchain:{resourceId:J,txHash:xe}}));const fe=`${W.replace(/\/$/,"")}/ipfs/${S}`;l(`CID: ${S}`,"info"),l(`Storacha IPFS: ${fe}`,"info")}else S&&(l("Uploaded to Storacha but wallet not available for proof","info"),l(`Storacha CID: ${S}`,"info"))}catch(h){console.warn("Storacha upload failed",h),l("Storacha upload failed; record remains on backend","error")}m(null),d(""),I(""),L(""),O("")}catch(t){console.error(t),l(`Upload failed: ${t.message||t}`,"error")}finally{$(!1)}};return e.jsxs("div",{className:"p-4 bg-white rounded-2xl border border-slate-100 shadow-sm",children:[e.jsx("h3",{className:"text-slate-800 font-semibold mb-3 text-base",children:"Secure Record Upload"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"This will encrypt the file locally, store the ciphertext on IPFS, and register a proof on-chain."}),e.jsxs("form",{onSubmit:de,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-1",children:"Search Patient (type name or MRN)"}),e.jsx("input",{type:"text",value:o,onChange:s=>{d(s.target.value),g("")},className:"w-full px-3 py-2 border border-slate-300 rounded-lg",placeholder:"Start typing to search..."}),e.jsxs("div",{className:"border rounded mt-1 max-h-40 overflow-auto bg-white",children:[u&&e.jsx("div",{className:"p-2 text-sm text-slate-500",children:"Searching..."}),b.slice(0,10).map(s=>{const t=s.id||s.patientId||s.mrn||s._id;return e.jsxs("div",{className:"p-2 hover:bg-slate-50 cursor-pointer",onClick:()=>{g(String(t)),d(s.name||""),N([])},children:[e.jsx("div",{className:"text-sm font-medium",children:s.name}),e.jsxs("div",{className:"text-xs text-slate-400",children:["MRN: ",String(t)]})]},t)}),E&&e.jsx("div",{className:"p-2 text-center",children:e.jsx("button",{type:"button",onClick:ce,className:"text-sm text-indigo-600",children:"Load more"})}),!u&&b.length===0&&o&&e.jsxs("div",{className:"p-2 text-xs text-slate-500",children:["No match â€” create a new patient ",e.jsx("button",{type:"button",onClick:()=>H(!0),className:"text-indigo-600 underline ml-1",children:"Create"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-1",children:"Record Type"}),e.jsx("input",{type:"text",value:D,onChange:s=>I(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg",placeholder:"e.g. Blood test, Prescription"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-1",children:"Record Date"}),e.jsx("input",{type:"date",value:A,onChange:s=>L(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-1",children:"Short Description"}),e.jsx("input",{type:"text",value:M,onChange:s=>O(s.target.value),className:"w-full px-3 py-2 border border-slate-300 rounded-lg",placeholder:"Optional note"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-600 mb-1",children:"Select File"}),e.jsx("input",{type:"file",onChange:le,className:"w-full text-slate-700 text-sm",accept:".pdf,.jpg,.png,.docx",required:!0})]}),e.jsx("button",{type:"submit",disabled:_,className:`w-full py-2 rounded-lg text-white font-medium transition-all duration-200 ${_?"bg-indigo-300 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-700 shadow-sm"}`,children:_?"Uploading...":"Upload Record"})]}),e.jsx("div",{className:"mt-3 text-xs text-slate-400 italic",children:"ðŸ”’ Files are encrypted locally (AES-GCM) before upload. The smart contract stores an immutable proof (CID + SHA-256) on-chain."}),i&&e.jsxs("div",{className:"mt-4 p-4 border border-slate-100 bg-white rounded-lg",children:[e.jsx("h4",{className:"font-semibold",children:"Upload Confirmation"}),e.jsxs("div",{className:"text-sm mt-2",children:["Patient ID: ",i.patientId]}),i.backendProof&&e.jsxs("div",{className:"text-sm mt-1",children:["Backend proof: ",e.jsx("code",{className:"text-xs bg-slate-100 px-2 py-1 rounded",children:String(i.backendProof)})]}),i.onchain&&e.jsxs("div",{className:"text-sm mt-1",children:["On-chain resource: ",e.jsx("code",{className:"text-xs bg-slate-100 px-2 py-1 rounded",children:String(i.onchain.resourceId)})]}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx("button",{type:"button",onClick:()=>ie(),className:"px-3 py-1 bg-indigo-600 text-white rounded",children:"Print Summary"}),e.jsx("button",{type:"button",onClick:()=>K(!0),className:"px-3 py-1 bg-green-600 text-white rounded",children:"View Details"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(Re,{patient:{id:i.patientId,name:o},ref:ne})})]}),oe&&i&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center bg-black/40 z-50",children:e.jsxs("div",{className:"bg-white rounded p-4 w-full max-w-lg",children:[e.jsx("h3",{className:"font-semibold",children:"Upload Details"}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"text-sm",children:["Patient ID: ",i.patientId]}),i.backendProof&&e.jsxs("div",{className:"mt-2",children:["Backend proof: ",e.jsx("code",{className:"bg-slate-100 px-2 py-1 rounded",children:i.backendProof}),e.jsx("button",{onClick:()=>Q(i.backendProof),className:"ml-2 text-xs px-2 py-1 border rounded",children:"Copy"})]}),i.onchain&&e.jsxs("div",{className:"mt-2",children:["On-chain resource: ",e.jsx("code",{className:"bg-slate-100 px-2 py-1 rounded",children:i.onchain.resourceId}),e.jsx("button",{onClick:()=>Q(i.onchain.resourceId),className:"ml-2 text-xs px-2 py-1 border rounded",children:"Copy"})]}),e.jsx("div",{className:"mt-4 flex justify-end gap-2",children:e.jsx("button",{onClick:()=>{K(!1)},className:"px-3 py-1 border rounded",children:"Close"})})]})]})}),re&&e.jsx("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Create Patient"}),e.jsxs("form",{onSubmit:async s=>{s.preventDefault(),q(!0);try{const t=new FormData(s.target),n={name:t.get("name"),mrn:t.get("mrn"),dob:t.get("dob"),gender:t.get("gender"),nationality:t.get("nationality"),state:t.get("state"),localGovernment:t.get("localGovernment"),allergies:t.get("allergies")},p=await k.createPatient(n),c=p.id||p.patientId||p.mrn||p._id||null;if(!c)throw new Error("No id returned");f(await k.listPatients()),g(String(c)),d(n.name||""),H(!1),l("Patient created","success")}catch(t){console.error(t),l("Failed to create patient","error")}finally{q(!1)}},className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Full name"}),e.jsx("input",{name:"name",className:"w-full border px-2 py-1 rounded",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"MRN (optional)"}),e.jsx("input",{name:"mrn",className:"w-full border px-2 py-1 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"DOB"}),e.jsx("input",{name:"dob",type:"date",className:"w-full border px-2 py-1 rounded"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Gender"}),e.jsxs("select",{name:"gender",className:"w-full border px-2 py-1 rounded",children:[e.jsx("option",{children:"Male"}),e.jsx("option",{children:"Female"}),e.jsx("option",{children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Nationality"}),e.jsx("input",{name:"nationality",className:"w-full border px-2 py-1 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"State"}),e.jsx("input",{name:"state",className:"w-full border px-2 py-1 rounded"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Local Government"}),e.jsx("input",{name:"localGovernment",className:"w-full border px-2 py-1 rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm",children:"Allergies / Notes"}),e.jsx("input",{name:"allergies",className:"w-full border px-2 py-1 rounded"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:()=>H(!1),className:"px-3 py-1 border rounded",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:G,className:"px-3 py-1 bg-indigo-600 text-white rounded",children:G?"Creating...":"Create"})]})]})]})})]})}const Be=r.lazy(()=>ke(()=>import("./Audit-Dm077oLr.js"),__vite__mapDeps([0,1,2,3])));function Le(){const[a,m]=r.useState([]),[o,d]=r.useState(!1),w="0xaCA3eF3906639995Fb31Bd58dbcDD0d3CFa2abE8";return r.useEffect(()=>{(async()=>{try{if(!window.ethereum){Z.error("MetaMask not detected!");return}d(!0);const j=new Y(window.ethereum),f=new ve(w,Se,j);let b=[];if(f.filters&&typeof f.filters.ResourceRegistered=="function"){const u=f.filters.ResourceRegistered();b=await f.queryFilter(u,0,"latest")}else try{b=await f.queryFilter({},0,"latest")}catch(u){console.warn("No event filters available",u),b=[]}const N=[];for(let u=0;u<b.length;u++){const v=b[u],x=v.args||[],R=x.resourceId||x[0],E=x.owner||x[1],P=x.cid||x[2]||"",D=x.metadata||x[4]||"";let I=new Date().toLocaleString();try{if(v.blockNumber&&j.getBlock){const A=await j.getBlock(v.blockNumber);I=new Date(Number(A.timestamp)*1e3).toLocaleString()}}catch{}N.push({id:u+1,title:D||`Record #${u+1}`,cid:P,resourceId:R?String(R):"",owner:E||"",timestamp:I})}m(N.reverse())}catch(j){console.error("Error fetching records:",j),Z.error("Failed to load encrypted records.")}finally{d(!1)}})()},[w]),e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"p-6 bg-white rounded-2xl shadow-sm",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-slate-700",children:"Upload New Patient Record"}),e.jsx(Ie,{})]}),e.jsxs("div",{className:"p-6 bg-white rounded-2xl shadow-sm",children:[e.jsx("h2",{className:"text-lg font-semibold mb-4 text-slate-700",children:"Access & Audit Overview"}),e.jsx(Ce,{}),e.jsx("div",{className:"mt-4",children:e.jsx(r.Suspense,{fallback:e.jsx("div",{className:"text-slate-500",children:"Loading Auditâ€¦"}),children:e.jsx(Be,{})})})]})]})})}export{Le as default};
